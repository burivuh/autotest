node("falcon") {
   pid = sh returnStdout: true, script: "ps -aux | grep \"manage.py runserver localhost:${port}\" | grep -v grep | awk '{print \$2}'"
   echo pid
   if (pid != "")
   for (def p in pid.split("\n"))
    sh "kill -9 ${p}"
   deleteDir()
     git credentialsId: 'jenkins-github-ssh', branch: git_branch, url: 'git@github.com:mapsme/autotest.git' 

     withCredentials([usernamePassword(credentialsId: 'kkravchuk-token', passwordVariable: 'jenkins_token', usernameVariable: 'jenkins_user')]) {
      dir('infrastructure/front') {
          sh "npm install"
          sh "npm run build"
      }
      
      if (new Boolean(migrations)) {
         dir('infrastructure/backend') {
          sh """#!/bin/bash
               set +x

               python3 -m venv ./autotest
               source ./autotest/bin/activate
               pip3 install -r requirements.txt
               python3 manage.py migrate
                               

              """
         }
      }
     
      dir('infrastructure/backend') {
          withEnv(['JENKINS_NODE_COOKIE=dontkill']) {
              sh """#!/bin/bash
               set +x
               python3 -m venv ./autotest
               source ./autotest/bin/activate
               pip3 install -r requirements.txt
               nohup python3 manage.py runserver localhost:${port} > /dev/null &
                               

              """
          }
      }
    }
}